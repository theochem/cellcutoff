matrix:
  include:
    - os: linux
      dist: xenial
      language: generic
      env:
        - ROBERTO_CONDA_PINNING="python 3.6"
        - ROBERTO_DEPLOY_BINARY=1
    - os: linux
      dist: xenial
      language: generic
      env:
        - ROBERTO_CONDA_PINNING="python 3.7"
        - ROBERTO_DEPLOY_NOARCH=1
        - ROBERTO_DEPLOY_BINARY=1
    - os: osx
      osx_image: xcode9.4
      language: generic
      env:
        - ROBERTO_CONDA_PINNING="python 3.6"
        - ROBERTO_DEPLOY_BINARY=1
    - os: osx
      osx_image: xcode9.4
      language: generic
      env:
        - ROBERTO_CONDA_PINNING="python 3.7"
        - ROBERTO_DEPLOY_BINARY=1

env:
  global:
    # Install conda in a *sub*directory of a directory cached by travis.
    - ROBERTO_CONDA_BASE_PATH=${HOME}/cache/miniconda3
    # Tell Roberto to upload coverage results
    - ROBERTO_UPLOAD_COVERAGE=1
    # Build conda packages outside the miniconda tree, to avoid caching.
    # This makes it possible to still deploy packages after cache cleaning.
    - CONDA_BLD_PATH=${HOME}/conda-bld
    # Tell roberto which branch is being merged into, in case of a PR.
    - ROBERTO_MERGE_BRANCH=${TRAVIS_BRANCH}
    # Debugging options
    # - HUB_VERBOSE=1

    # GITHUB_TOKEN
    # yamllint disable-line rule:line-length
    - secure: "NjbLobJPQfMG1zet8lWF1yEbfvgyBPnoq40pL4Y9akUnj8hdnlvMMXUnse+LNhbfaKAxLayCIZ8qMoiKbPyhJGrliZxz/MaPJm62SwGskWbu6csINBgF38NkqEx2hVhX6NWnL6Yc56SZ188qQVUm4jOwZWRxzD5Qh/Y1S1yZbkHd6j61DAOKQv6FImqaXkSKEW3996dw2ZGceYzMv9yvJpnjqLO71TlUXVuCtT7ODhG5CqHIGeaVxRoxh8TPZSBaGuKyXbuWliOfoyAzmufvApr92+2xzxGphOSOWm8MkfjbNV8OQgHJ5RtI04kg7/R0hBwnBBym2+gzcinH/AZ6+tQ3nlp5eZtBpxJ6mc/MTPJrr7hIaOh5jLnjtFphs2ebnF7mRkwwsFQrQ6dB5ZoZqvdcSZbxGNf6EjrUKt52pqJ26BJEKTB+Sk2xQnkzBdUlHJStyvPMjGu8AEGCEXRFLufr3/r1dHqskNQv+7TY6hFbHAeQHAXDjlEyYat5qYonhoqZk6XB48tW5EUZss6xcn7JkxFiOhZGRQIH0lWi+r+/MFIN/v7zIfRZvwPOFgYOFzaSg/lVW+3h/KVE88sDa93rlcyiA01+v5k0jLsmFOS69fakjFOvkMmRemPqV/VanG5x3A/zWvO2sJQ0A+u+gAkJQUyoaM1ZFLufy61tANE="
    # ANACONDA_API_TOKEN
    # yamllint disable-line rule:line-length
    - secure: "rWLvl4K+U3sz7RaEIDlDU0bI5k9a/JWqqpkd3gNRpR4v9SvnO7xZS399ThqYDOGkJetXh080RyZKK7UtnhMkewKluwRzRS2XTnL44csafTvInf7nQ+Jal2BxjZc/dPVKITExrZf41s+RmUm7OGtozqQ47LtlEKGj0hsIFpPe00reEYQP9ycU9Sp4edD7a1Jdx5xjdleQ5c4ho/3t/LzapTZM39R0iWL4bwA3EFSJYuF7Mvgg79UB50ml9AmLQbqsEQeDEGUR5UUZUyCgCAjVT4c3O8P7c7qX+HskjF/i1pugHkduxO+qsmGTLMvTRWG82UnJrtwGQE1t9B6yLNZKISujk7j3TZPtemYIuw2f47XrAyPjARXEPbRaklFQFnANzWO1XWNmB4rG1HJf9SjtOVm8gUp2tLzyfg1gFVUk7gl7SDT1vqCEB8lSLlj8ibperSPhsfiGmSRU1Bnp0763RcO5VDXkLaMK7z9GeSJCvmLztUeT7TLc0ceqhTUZGcaZ8EY6tVDO2UzCbF+yHLbgigVw3O1NvOKX4foSceWRwuwyw5FhjrrvzX7ld7ASNxK0Zag00NyWKlG23HVESSODnUR1uCDTk+7LZZYzuyzr/iGy8DLQRUaX4K67YKYt0v98r+jLgkpuWSmcv8uTccPbIIcSolVhL2f3yVYMp4G8Drw="

cache:
  # More time is needed for caching due to the sheer size of the conda env.
  timeout: 1000
  directories:
    - ${HOME}/cache

install:
  # Disable deployment when TRAVIS_TAG is not set. This avoids duplicate deployments.
  - if [[ -z $TRAVIS_TAG ]]; then
      export ROBERTO_DEPLOY_BINARY=0 ROBERTO_DEPLOY_NOARCH=0;
    fi
  # Get a basic python 3 with pip to run roberto
  - python3 --version
  - wget --no-clobber -O ${HOME}/cache/get-pip.py https://bootstrap.pypa.io/get-pip.py || true
  - python3 ${HOME}/cache/get-pip.py --user
  # - python3 -m pip install 'roberto<2.0.0' --user
  # Use development version of Roberto to avoid having to make too many releases.
  - python3 -m pip install git+https://github.com/theochem/roberto#egg=roberto

script:
  # Instead of simply calling `rob`, we do something that always works on osx too.
  - if [[ "$TRAVIS_PULL_REQUEST" == "false" ]]; then
      python3 -m roberto robot;
    else
      python3 -m roberto;
    fi

before_cache:
  - rm -rf ${ROBERTO_CONDA_BASE_PATH}/conda-bld
  - rm -rf ${ROBERTO_CONDA_BASE_PATH}/locks
  - rm -rf ${ROBERTO_CONDA_BASE_PATH}/pkgs
  - rm -rf ${ROBERTO_CONDA_BASE_PATH}/var
  - rm -rf ${ROBERTO_CONDA_BASE_PATH}/envs/*/conda-bld
  - rm -rf ${ROBERTO_CONDA_BASE_PATH}/envs/*/locks
  - rm -rf ${ROBERTO_CONDA_BASE_PATH}/envs/*/pkgs
  - rm -rf ${ROBERTO_CONDA_BASE_PATH}/envs/*/var
